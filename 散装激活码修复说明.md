# 散装激活码逻辑修复说明

## 🐛 发现的问题

通过对比电脑端(`app_main.py`)和安卓端(`main_chinese.py`)的散装激活码逻辑，发现了以下不一致：

### **1. 激活码验证标准不同**

#### **电脑端标准**：
```python
def _is_valid_code(self, s: str) -> bool:
    s = s.strip()
    if len(s) != 10:           # 必须是10位
        return False
    for ch in s:
        if not (ch.isdigit() or ('A' <= ch <= 'Z')):  # 只能是大写字母A-Z和数字0-9
            return False
    return True
```

#### **安卓端原来的标准**：
```python
# 原来的错误逻辑
len(line) >= 8 and line.isalnum()  # 至少8位，包含任何字母数字
```

### **2. 空行插入位置不正确**

#### **电脑端逻辑**：
```python
for idx, code in enumerate(codes[:25], start=1):
    div_lines.append(f"<div class=\"bulk-line\">{code}</div>")
    if idx in (10, 15):  # 在第10和15个激活码后插入空行
        div_lines.append("<div class=\"bulk-line\"><br></div>")
```

#### **安卓端原来的逻辑**：
```python
# 原来的错误逻辑
for i, code in enumerate(codes_1[:25]):
    if i == 10 or i == 15:  # 错误：在第10和15个激活码前插入空行
        content_parts.append('')
    content_parts.append(code)
```

## ✅ 修复内容

### **1. 统一激活码验证标准**

**添加了与电脑端完全一致的验证函数**：
```python
def is_valid_code(self, s: str) -> bool:
    """验证激活码是否有效 - 与桌面端逻辑一致"""
    s = s.strip()
    if len(s) != 10:
        return False
    for ch in s:
        if not (ch.isdigit() or ('A' <= ch <= 'Z')):
            return False
    return True
```

**更新了读取文件的过滤逻辑**：
```python
if (line and 
    not line.startswith('#') and 
    not line.startswith('激活码列表') and
    not line.startswith('生成时间') and
    not line.startswith('总数') and
    not line.startswith('字符集') and
    not line.startswith('===') and
    not line.startswith('第') and
    not line.startswith('组') and
    '组' not in line and
    not '以下是25个1天的激活码' in line and
    self.is_valid_code(line)):  # 使用新的验证函数
```

### **2. 修复空行插入逻辑**

**修正了空行插入位置**：
```python
# 修复后的正确逻辑
for i, code in enumerate(codes_1[:25]):
    content_parts.append(code)
    # 在第10和15个激活码后添加空行
    if i == 9 or i == 14:  # 索引从0开始，第10个是索引9，第15个是索引14
        content_parts.append('')
```

### **3. 更新文件上传验证**

**上传文件时也使用相同的验证标准**：
```python
for line in lines:
    line = line.strip()
    if (line and 
        not line.startswith('#') and 
        self.is_valid_code(line)):  # 使用统一的验证函数
        test_codes.append(line)
```

## 📊 激活码格式要求

### **标准格式**：
- **长度**：必须是10位
- **字符集**：只能包含大写字母A-Z和数字0-9
- **示例**：`ABC123DEF4`, `XYZ789GHI0`, `JKL456MNO1`

### **无效格式**：
❌ `abc123def4` - 包含小写字母  
❌ `ABC123DEF` - 只有9位  
❌ `ABC123DEF45` - 有11位  
❌ `ABC123-DEF4` - 包含特殊字符  
❌ `ABC123def4` - 混合大小写  

## 🔄 散装显示格式

**修复后的散装激活码显示格式**：
```
以下是25个1天的激活码，激活之后才开始生效：
ABC123DEF4
XYZ789GHI0
JKL456MNO1
PQR789STU2
VWX012YZA3
BCD345EFG6
HIJ678KLM7
NOP901QRS8
TUV234WXY9
ZAB567CDE0

FGH890IJK1    ← 第10个后有空行
LMN123OPQ2
RST456UVW3
XYZ789ABC4
DEF012GHI5

JKL345MNO6    ← 第15个后有空行
PQR678STU7
VWX901YZA8
BCD234EFG9
HIJ567KLM0
NOP890QRS1
TUV123WXY2
ZAB456CDE3
FGH789IJK4
LMN012OPQ5
```

## 🧪 测试文件

**创建了标准测试文件** `test_codes_30day.txt`：
- 包含30个有效的10位激活码
- 符合大写字母A-Z和数字0-9的要求
- 可用于测试上传功能

## 🎯 修复效果

### **修复前的问题**：
1. 激活码验证标准不一致，可能读取到无效激活码
2. 空行位置错误，影响显示格式
3. 上传文件验证标准不统一

### **修复后的改进**：
1. ✅ 激活码验证与电脑端完全一致
2. ✅ 散装显示格式与电脑端一致
3. ✅ 文件上传验证使用相同标准
4. ✅ 空行插入位置正确（第10和15个激活码后）
5. ✅ 过滤逻辑更完善，排除标题和分隔符

现在安卓端的散装激活码功能与电脑端完全一致！
