name: ğŸš€ æ„å»ºå‘è´§åŠ©æ‰‹APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-apk:
    runs-on: ubuntu-20.04
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        
    - name: â˜• è®¾ç½®Javaç¯å¢ƒ  
      uses: actions/setup-java@v3
      with:
        distribution: 'adopt'
        java-version: '8'
        
    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip openjdk-8-jdk build-essential ccache autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake libffi-dev libssl-dev
        
    - name: ğŸ”§ å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install buildozer==1.5.0 cython==0.29.33
        
    - name: ğŸ—ï¸ æ„å»ºAPK
      run: |
        echo "ğŸš€ å¼€å§‹æ„å»ºAPK..."
        echo "ğŸ“ å½“å‰ç›®å½•ï¼š$(pwd)"
        echo "ğŸ“‹ æ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -la
        
        # éªŒè¯å¿…è¦æ–‡ä»¶
        if [ ! -f "buildozer.spec" ]; then
          echo "âŒ buildozer.specæ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        if [ ! -f "main_chinese.py" ]; then
          echo "âŒ main_chinese.pyæ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export ANDROIDAPI="30"
        export NDKAPI="21"
        
        # å¼€å§‹æ„å»º
        buildozer android debug
        
    - name: ğŸ“± ä¸Šä¼ APKæ–‡ä»¶
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: å‘è´§åŠ©æ‰‹-APK
        path: bin/*.apk
        retention-days: 30
        
    - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      if: always()
      run: |
        echo "ğŸ“¦ æ„å»ºå®ŒæˆçŠ¶æ€æ£€æŸ¥ï¼š"
        if [ -d "bin" ]; then
          echo "âœ… binç›®å½•å­˜åœ¨"
          ls -la bin/
        else
          echo "âŒ binç›®å½•ä¸å­˜åœ¨"
        fi
        
        echo "ğŸ“‹ buildozeræ—¥å¿—ä½ç½®ï¼š"
        find . -name "*.log" -type f | head -5
